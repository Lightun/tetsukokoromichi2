<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スコア推移可視化</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <a href="compare.html" style="font-size: 1.1em; color: blue; text-decoration: underline;">対戦相手との比較</a>

  <h2>スコア推移</h2>
  <label for="userSelect">ユーザー:</label>
  <select id="userSelect"></select>

  <label for="songSelect">曲:</label>
  <select id="songSelect"></select>

  <button id="showBtn">表示</button>

  <!-- <canvas id="scoreChart" width="800" height="600"></canvas> -->
  <div style="width: 90%; max-width: 800px; text-align: left;">
    <canvas id="scoreChart"></canvas>
  </div>

  <!-- <h2>曲の統計情報</h2>
  <div id="statsText" style="font-size:1.1em; margin-top:10px;"></div> -->

  <style>
    .container {
      width: 90%;
      max-width: 900px;   /* 全体の最大幅 */
      margin: 0 auto;
      font-size: 1.2em;   /* フォントを大きく */
    }

    /* フォーム要素を大きく */
    select, button {
      font-size: 1.2em;
      padding: 6px 12px;
      margin: 4px 8px 12px 0;
    }
    #scoreChart {
      display: block;
      width: 100%;      /* 横幅は親要素に合わせる */
      height: 400px;    /* 高さを大きくする */
      margin: 0;
    }
  </style>

<script>
  const files = ['1003.csv','1004.csv','1005.csv','1006.csv','1007.csv','1008.csv','1009.csv','1010.csv','1011.csv','1012.csv','1013.csv','1014.csv','1015.csv','1016.csv','1017.csv','1018.csv',
    '1019.csv','1020.csv','1021.csv','1022.csv','1023.csv','1025.csv','1026.csv','1027.csv','1028.csv','1029.csv','1030.csv','1031.csv'];
  const userScores = {};
  let users = [];
  let songs = [];

  async function loadCSV(file) {
    const res = await fetch(file);
    const text = await res.text();
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');

    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(',');
      const player = row[0];

      if (!userScores[player]) userScores[player] = {};
      if (!users.includes(player)) users.push(player);

      for (let j = 1; j < headers.length; j++) {
        const song = headers[j];
        if (!songs.includes(song)) songs.push(song);

        const score = parseFloat(row[j]);
        if (!userScores[player][song]) userScores[player][song] = [];
        userScores[player][song].push(score);
      }
    }
  }

  async function main() {
    for (const file of files) {
      await loadCSV(file);
    }

    const userSelect = document.getElementById('userSelect');
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      userSelect.appendChild(opt);
    });

    const songSelect = document.getElementById('songSelect');
    songs.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      songSelect.appendChild(opt);
    });
  }

  let chartInstance = null;

  function calcStats(arr) {
    const filtered = arr.filter(v => typeof v === 'number' && v !== 0 && !isNaN(v));
    const sorted = [...filtered].sort((a,b)=>a-b);
    const sum = filtered.reduce((a,b)=>a+b,0);
    const avg = filtered.length > 0 ? Math.round(sum / filtered.length) : 0;
    const min = sorted.length > 0 ? sorted[0] : 0;
    const max = sorted.length > 0 ? sorted[sorted.length-1] : 0;
    const median = sorted.length > 0
      ? (sorted.length % 2 === 0
          ? Math.round((sorted[sorted.length/2-1]+sorted[sorted.length/2])/2)
          : sorted[Math.floor(sorted.length/2)])
      : 0;
    return {avg, min, max, median};
  }

  document.getElementById('showBtn').addEventListener('click', () => {
    const user = document.getElementById('userSelect').value;
    const song = document.getElementById('songSelect').value;
    const scores = userScores[user][song];

    const ctx = document.getElementById('scoreChart').getContext('2d');

    // 各ファイルごとに統計を算出
    const avgPerFile = [];
    const maxPerFile = [];
    const minPerFile = [];
    const medianPerFile = [];

    files.forEach((file, idx) => {
      const allScores = users.map(u => userScores[u][song]?.[idx]).filter(v => v);
      const stats = calcStats(allScores);
      avgPerFile.push(stats.avg);
      maxPerFile.push(stats.max);
      minPerFile.push(stats.min);
      medianPerFile.push(stats.median);
    });

    // 最新データの統計を表示
    // const current_scores = users.map(u => userScores[u][song][files.length - 1]).filter(v => v);
    // if (current_scores.length > 0) {
    //   const stats = calcStats(current_scores);
    //   document.getElementById('statsText').innerHTML =
    //     `平均: ${stats.avg}<br>最大: ${stats.max}<br>最小: ${stats.min}<br>中央値: ${stats.median}`;
    // } else {
    //   document.getElementById('statsText').textContent = '最新のデータがありません';
    // }

    if (chartInstance) chartInstance.destroy();

    // 🎨 複数の線を重ねて表示
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: files,
        datasets: [
          {
            label: `${user} のスコア`,
            data: scores,
            fill: false,
            borderColor: 'rgba(75, 192, 192, 1)', // 緑
            tension: 0.1,
            borderWidth: 2
          },
          {
            label: '平均スコア',
            data: avgPerFile,
            fill: false,
            borderColor: 'rgba(255, 159, 64, 1)', // オレンジ
            borderDash: [6, 4],
            tension: 0.1,
            borderWidth: 2
          },
          {
            label: '最大スコア',
            data: maxPerFile,
            fill: false,
            borderColor: 'rgba(54, 162, 235, 1)', // 青
            borderDash: [3, 3],
            tension: 0.1,
            borderWidth: 1.5
          },
          {
            label: '最小スコア',
            data: minPerFile,
            fill: false,
            borderColor: 'rgba(255, 99, 132, 1)', // 赤
            borderDash: [3, 3],
            tension: 0.1,
            borderWidth: 1.5
          },
          {
            label: '中央値',
            data: medianPerFile,
            fill: false,
            borderColor: 'rgba(153, 102, 255, 1)', // 紫
            borderDash: [8, 4],
            tension: 0.1,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            max: 1000000,
            min: 980000,
            title: { display: true, text: 'スコア' }
          },
          x: {
            title: { display: true, text: 'データ日付 (CSV)' }
          }
        },
        plugins: {
          title: {
            display: true,
            text: `${song} のスコア推移（統計付き）`
          },
          legend: {
            position: 'bottom',
            labels: { boxWidth: 20 }
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
  });

  main();
</script>
</body>
</html>